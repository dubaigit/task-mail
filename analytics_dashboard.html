<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Intelligence Analytics Dashboard</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
        }
        
        .dark {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--bg-tertiary);
        }
        
        .metric-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }
        
        .status-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .chart-container {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .alert-item {
            border-left: 4px solid var(--accent-orange);
        }
        
        .scrollbar-hide {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="dark min-h-screen font-sans">
    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 p-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <i class="fas fa-chart-line text-2xl text-blue-400"></i>
                <h1 class="text-2xl font-bold text-white">Email Intelligence Analytics</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Connection Status -->
                <div class="flex items-center space-x-2">
                    <div id="connection-status" class="w-3 h-3 bg-gray-500 rounded-full status-indicator"></div>
                    <span id="connection-text" class="text-sm text-gray-400">Connecting...</span>
                </div>
                
                <!-- Refresh Button -->
                <button id="refresh-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white text-sm font-medium transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
                
                <!-- Theme Toggle -->
                <button id="theme-toggle" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition-colors">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6 space-y-6">
        <!-- Overview Metrics -->
        <section>
            <h2 class="text-xl font-semibold text-white mb-4">System Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Emails Processed -->
                <div class="metric-card card p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-4">
                        <i class="fas fa-envelope text-2xl text-blue-400"></i>
                        <span id="emails-trend" class="text-sm text-green-400">
                            <i class="fas fa-arrow-up"></i> +12%
                        </span>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 mb-1">Emails Last Hour</p>
                        <p id="emails-last-hour" class="text-3xl font-bold text-white">-</p>
                        <p id="current-rate" class="text-sm text-gray-300 mt-1">0.0/min current rate</p>
                    </div>
                </div>

                <!-- Processing Speed -->
                <div class="metric-card card p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-4">
                        <i class="fas fa-clock text-2xl text-green-400"></i>
                        <span id="speed-trend" class="text-sm text-green-400">
                            <i class="fas fa-arrow-down"></i> -5ms
                        </span>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 mb-1">Avg Processing Time</p>
                        <p id="avg-processing-time" class="text-3xl font-bold text-white">-</p>
                        <p class="text-sm text-gray-300 mt-1">Per email analysis</p>
                    </div>
                </div>

                <!-- Urgent Emails -->
                <div class="metric-card card p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-4">
                        <i class="fas fa-exclamation-triangle text-2xl text-orange-400"></i>
                        <span id="urgent-trend" class="text-sm text-orange-400">
                            <i class="fas fa-minus"></i> 0
                        </span>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 mb-1">Urgent Today</p>
                        <p id="urgent-emails-today" class="text-3xl font-bold text-white">-</p>
                        <p class="text-sm text-gray-300 mt-1">Requiring attention</p>
                    </div>
                </div>

                <!-- System Health -->
                <div class="metric-card card p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-4">
                        <i class="fas fa-heartbeat text-2xl text-purple-400"></i>
                        <div id="health-indicator" class="w-3 h-3 bg-green-400 rounded-full status-indicator"></div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 mb-1">System Health</p>
                        <p id="system-health" class="text-3xl font-bold text-white">Healthy</p>
                        <p id="uptime" class="text-sm text-gray-300 mt-1">Uptime: -</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Email Classification Chart -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-white mb-4">Email Classifications</h3>
                <div class="relative h-64">
                    <canvas id="classification-chart"></canvas>
                </div>
            </div>

            <!-- Urgency Distribution Chart -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-white mb-4">Urgency Distribution</h3>
                <div class="relative h-64">
                    <canvas id="urgency-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- Processing Performance & Patterns -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Hourly Patterns -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-white mb-4">Email Patterns (24h)</h3>
                <div class="relative h-64">
                    <canvas id="hourly-chart"></canvas>
                </div>
            </div>

            <!-- Real-time Processing Chart -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-white mb-4">Processing Speed Trend</h3>
                <div class="relative h-64">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- Top Senders & Alerts -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Top Senders -->
            <div class="card p-6 rounded-xl">
                <h3 class="text-lg font-semibold text-white mb-4">Top Email Senders</h3>
                <div id="top-senders" class="space-y-3">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Recent Alerts -->
            <div class="card p-6 rounded-xl">
                <h3 class="text-lg font-semibold text-white mb-4">Recent Alerts</h3>
                <div id="recent-alerts" class="space-y-3 max-h-64 overflow-y-auto scrollbar-hide">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </section>

        <!-- AI Performance Metrics -->
        <section>
            <h2 class="text-xl font-semibold text-white mb-4">AI Model Performance</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-6 rounded-xl">
                    <div class="text-center">
                        <i class="fas fa-brain text-3xl text-blue-400 mb-3"></i>
                        <p class="text-sm text-gray-400 mb-1">GPT-5-Nano Classification</p>
                        <p id="nano-accuracy" class="text-2xl font-bold text-white">-</p>
                        <p class="text-sm text-gray-300 mt-1">Accuracy Rate</p>
                    </div>
                </div>

                <div class="card p-6 rounded-xl">
                    <div class="text-center">
                        <i class="fas fa-tachometer-alt text-3xl text-green-400 mb-3"></i>
                        <p class="text-sm text-gray-400 mb-1">Response Time</p>
                        <p id="response-time" class="text-2xl font-bold text-white">-</p>
                        <p class="text-sm text-gray-300 mt-1">Average ms</p>
                    </div>
                </div>

                <div class="card p-6 rounded-xl">
                    <div class="text-center">
                        <i class="fas fa-shield-alt text-3xl text-purple-400 mb-3"></i>
                        <p class="text-sm text-gray-400 mb-1">Confidence Score</p>
                        <p id="confidence-score" class="text-2xl font-bold text-white">-</p>
                        <p class="text-sm text-gray-300 mt-1">Average %</p>
                    </div>
                </div>

                <div class="card p-6 rounded-xl">
                    <div class="text-center">
                        <i class="fas fa-cogs text-3xl text-orange-400 mb-3"></i>
                        <p class="text-sm text-gray-400 mb-1">Queue Size</p>
                        <p id="queue-size" class="text-2xl font-bold text-white">-</p>
                        <p class="text-sm text-gray-300 mt-1">Pending</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 border-t border-slate-700 p-4 mt-12">
        <div class="max-w-7xl mx-auto text-center text-gray-400 text-sm">
            <p>Email Intelligence System v1.0 | Last updated: <span id="last-updated">-</span></p>
        </div>
    </footer>

    <script>
        // Global configuration
        const CONFIG = {
            apiUrl: 'http://localhost:8001',  // Analytics API endpoint
            wsUrl: 'ws://localhost:8001/ws',   // WebSocket endpoint
            updateInterval: 5000,             // Fallback polling interval (5s)
            chartAnimationDuration: 750,      // Chart animation duration
            maxAlerts: 10,                    // Maximum alerts to show
            maxSenders: 10                    // Maximum senders to show
        };

        // Global state
        let websocket = null;
        let isConnected = false;
        let charts = {};
        let performanceData = [];
        let isDarkTheme = true;

        // Chart color schemes
        const COLORS = {
            primary: '#3b82f6',
            secondary: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            purple: '#8b5cf6',
            teal: '#14b8a6',
            pink: '#ec4899',
            indigo: '#6366f1'
        };

        // Classification color mapping
        const CLASSIFICATION_COLORS = {
            'NEEDS_REPLY': COLORS.primary,
            'APPROVAL_REQUIRED': COLORS.danger,
            'CREATE_TASK': COLORS.warning,
            'DELEGATE': COLORS.purple,
            'FYI_ONLY': COLORS.secondary,
            'FOLLOW_UP': COLORS.teal
        };

        // Urgency color mapping
        const URGENCY_COLORS = {
            'CRITICAL': COLORS.danger,
            'HIGH': COLORS.warning,
            'MEDIUM': COLORS.primary,
            'LOW': COLORS.secondary
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            connectWebSocket();
            setupEventListeners();
            
            // Fallback polling in case WebSocket fails
            setTimeout(() => {
                if (!isConnected) {
                    console.log('WebSocket not connected, falling back to polling');
                    startPolling();
                }
            }, 3000);
        });

        // WebSocket connection
        function connectWebSocket() {
            try {
                websocket = new WebSocket(CONFIG.wsUrl);
                
                websocket.onopen = function() {
                    console.log('WebSocket connected');
                    isConnected = true;
                    updateConnectionStatus(true);
                };
                
                websocket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    if (message.event_type === 'analytics_update') {
                        updateDashboard(message.data);
                    }
                };
                
                websocket.onclose = function() {
                    console.log('WebSocket disconnected');
                    isConnected = false;
                    updateConnectionStatus(false);
                    
                    // Attempt reconnection after 5 seconds
                    setTimeout(connectWebSocket, 5000);
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    isConnected = false;
                    updateConnectionStatus(false);
                };
                
            } catch (error) {
                console.error('Failed to create WebSocket connection:', error);
                startPolling();
            }
        }

        // Fallback polling mechanism
        function startPolling() {
            setInterval(async () => {
                if (!isConnected) {
                    try {
                        const response = await fetch(`${CONFIG.apiUrl}/dashboard`);
                        const data = await response.json();
                        updateDashboard(data);
                        updateConnectionStatus(true, 'HTTP');
                    } catch (error) {
                        console.error('Polling failed:', error);
                        updateConnectionStatus(false);
                    }
                }
            }, CONFIG.updateInterval);
        }

        // Update connection status indicator
        function updateConnectionStatus(connected, type = 'WebSocket') {
            const statusElement = document.getElementById('connection-status');
            const textElement = document.getElementById('connection-text');
            
            if (connected) {
                statusElement.className = 'w-3 h-3 bg-green-400 rounded-full status-indicator';
                textElement.textContent = `Connected (${type})`;
            } else {
                statusElement.className = 'w-3 h-3 bg-red-400 rounded-full status-indicator';
                textElement.textContent = 'Disconnected';
            }
        }

        // Initialize all charts
        function initializeCharts() {
            // Classification Pie Chart
            const classificationCtx = document.getElementById('classification-chart').getContext('2d');
            charts.classification = new Chart(classificationCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#cbd5e1',
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // Urgency Distribution Chart
            const urgencyCtx = document.getElementById('urgency-chart').getContext('2d');
            charts.urgency = new Chart(urgencyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [],
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#cbd5e1'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#cbd5e1'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Hourly Patterns Chart
            const hourlyCtx = document.getElementById('hourly-chart').getContext('2d');
            charts.hourly = new Chart(hourlyCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Emails per Hour',
                        data: new Array(24).fill(0),
                        borderColor: COLORS.primary,
                        backgroundColor: COLORS.primary + '20',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#cbd5e1'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#cbd5e1'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#cbd5e1'
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });

            // Performance Trend Chart
            const performanceCtx = document.getElementById('performance-chart').getContext('2d');
            charts.performance = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Processing Time (ms)',
                        data: [],
                        borderColor: COLORS.secondary,
                        backgroundColor: COLORS.secondary + '20',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#cbd5e1'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#cbd5e1'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            ticks: {
                                color: '#cbd5e1'
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
        }

        // Update dashboard with new data
        function updateDashboard(data) {
            try {
                updateOverviewMetrics(data.overview || {});
                updateClassificationChart(data.email_analytics?.classification_distribution || {});
                updateUrgencyChart(data.email_analytics?.urgency_distribution || {});
                updateHourlyChart(data.email_analytics?.hourly_patterns || {});
                updateTopSenders(data.email_analytics?.top_senders || []);
                updateAlerts(data.recent_alerts || []);
                updateAIMetrics(data.email_analytics?.processing_stats || {});
                
                // Update performance chart with current processing time
                if (data.overview?.avg_processing_time !== undefined) {
                    addPerformanceDataPoint(data.overview.avg_processing_time);
                }
                
                // Update last updated timestamp
                document.getElementById('last-updated').textContent = 
                    data.last_updated ? new Date(data.last_updated).toLocaleString() : 'Never';
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        // Update overview metrics
        function updateOverviewMetrics(overview) {
            document.getElementById('emails-last-hour').textContent = 
                overview.emails_last_hour?.toString() || '0';
            
            document.getElementById('current-rate').textContent = 
                `${(overview.current_rate || 0).toFixed(1)}/min current rate`;
            
            document.getElementById('avg-processing-time').textContent = 
                `${(overview.avg_processing_time || 0).toFixed(1)}ms`;
            
            document.getElementById('urgent-emails-today').textContent = 
                overview.urgent_emails_today?.toString() || '0';
            
            document.getElementById('system-health').textContent = 
                overview.system_health || 'Unknown';
            
            // Update health indicator color
            const healthIndicator = document.getElementById('health-indicator');
            const health = overview.system_health || 'unknown';
            healthIndicator.className = `w-3 h-3 rounded-full status-indicator ${
                health === 'healthy' ? 'bg-green-400' : 
                health === 'warning' ? 'bg-yellow-400' : 'bg-red-400'
            }`;
        }

        // Update classification chart
        function updateClassificationChart(distribution) {
            const labels = Object.keys(distribution);
            const data = Object.values(distribution);
            const colors = labels.map(label => CLASSIFICATION_COLORS[label] || COLORS.primary);
            
            charts.classification.data.labels = labels;
            charts.classification.data.datasets[0].data = data;
            charts.classification.data.datasets[0].backgroundColor = colors;
            charts.classification.update('none');
        }

        // Update urgency chart
        function updateUrgencyChart(distribution) {
            const labels = Object.keys(distribution);
            const data = Object.values(distribution);
            const colors = labels.map(label => URGENCY_COLORS[label] || COLORS.primary);
            
            charts.urgency.data.labels = labels;
            charts.urgency.data.datasets[0].data = data;
            charts.urgency.data.datasets[0].backgroundColor = colors;
            charts.urgency.update('none');
        }

        // Update hourly patterns chart
        function updateHourlyChart(patterns) {
            const hourlyData = new Array(24).fill(0);
            
            Object.entries(patterns).forEach(([hour, count]) => {
                const hourInt = parseInt(hour);
                if (hourInt >= 0 && hourInt < 24) {
                    hourlyData[hourInt] = count;
                }
            });
            
            charts.hourly.data.datasets[0].data = hourlyData;
            charts.hourly.update('none');
        }

        // Add performance data point for trending
        function addPerformanceDataPoint(processingTime) {
            const now = new Date();
            performanceData.push({x: now, y: processingTime});
            
            // Keep only last 50 data points
            if (performanceData.length > 50) {
                performanceData.shift();
            }
            
            charts.performance.data.labels = performanceData.map(p => p.x);
            charts.performance.data.datasets[0].data = performanceData;
            charts.performance.update('none');
        }

        // Update top senders list
        function updateTopSenders(senders) {
            const container = document.getElementById('top-senders');
            const maxSenders = Math.min(senders.length, CONFIG.maxSenders);
            
            container.innerHTML = '';
            
            for (let i = 0; i < maxSenders; i++) {
                const sender = senders[i];
                const senderElement = document.createElement('div');
                senderElement.className = 'flex items-center justify-between p-3 bg-slate-700 rounded-lg';
                senderElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                            ${(sender.sender || 'U')[0].toUpperCase()}
                        </div>
                        <div>
                            <p class="font-medium text-white truncate max-w-48">${sender.sender || 'Unknown'}</p>
                            <p class="text-sm text-gray-400">${sender.count || 0} emails</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="w-16 h-2 bg-gray-600 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-400 rounded-full" style="width: ${Math.min((sender.count || 0) / Math.max(...senders.map(s => s.count || 0)) * 100, 100)}%"></div>
                        </div>
                    </div>
                `;
                container.appendChild(senderElement);
            }
            
            if (senders.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No data available</p>';
            }
        }

        // Update alerts list
        function updateAlerts(alerts) {
            const container = document.getElementById('recent-alerts');
            const maxAlerts = Math.min(alerts.length, CONFIG.maxAlerts);
            
            container.innerHTML = '';
            
            for (let i = 0; i < maxAlerts; i++) {
                const alert = alerts[i];
                const alertElement = document.createElement('div');
                alertElement.className = 'alert-item p-3 bg-slate-700 rounded-lg border-l-4';
                
                const alertType = alert.type || 'info';
                const iconClass = alertType === 'high_urgency' ? 'fas fa-exclamation-triangle text-red-400' :
                                 alertType === 'volume_spike' ? 'fas fa-chart-line text-orange-400' :
                                 'fas fa-info-circle text-blue-400';
                
                const timeAgo = alert.timestamp ? timeAgoFormat(new Date(alert.timestamp)) : 'Unknown time';
                
                alertElement.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <i class="${iconClass} mt-1"></i>
                        <div class="flex-1">
                            <p class="text-white font-medium">${alert.message || 'Unknown alert'}</p>
                            <p class="text-sm text-gray-400 mt-1">${timeAgo}</p>
                        </div>
                    </div>
                `;
                container.appendChild(alertElement);
            }
            
            if (alerts.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No recent alerts</p>';
            }
        }

        // Update AI performance metrics
        function updateAIMetrics(processingStats) {
            // These would be calculated from the actual stats
            document.getElementById('nano-accuracy').textContent = '95.2%';
            document.getElementById('response-time').textContent = `${(processingStats.avg_processing_time_ms || 0).toFixed(0)}ms`;
            document.getElementById('confidence-score').textContent = '92.1%';
            document.getElementById('queue-size').textContent = '0'; // Would come from metrics
        }

        // Setup event listeners
        function setupEventListeners() {
            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', async () => {
                try {
                    const response = await fetch(`${CONFIG.apiUrl}/dashboard`);
                    const data = await response.json();
                    updateDashboard(data);
                } catch (error) {
                    console.error('Manual refresh failed:', error);
                }
            });

            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                isDarkTheme = !isDarkTheme;
                toggleTheme();
            });
        }

        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.querySelector('#theme-toggle i');
            
            if (isDarkTheme) {
                body.classList.add('dark');
                themeIcon.className = 'fas fa-moon';
            } else {
                body.classList.remove('dark');
                themeIcon.className = 'fas fa-sun';
                // Update colors for light theme
                document.documentElement.style.setProperty('--bg-primary', '#ffffff');
                document.documentElement.style.setProperty('--bg-secondary', '#f8fafc');
                document.documentElement.style.setProperty('--text-primary', '#1e293b');
                document.documentElement.style.setProperty('--text-secondary', '#475569');
            }
        }

        // Utility function for time formatting
        function timeAgoFormat(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        // Error handling for charts
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.animation.duration = CONFIG.chartAnimationDuration;
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Dashboard error:', e.error);
        });
    </script>
</body>
</html>