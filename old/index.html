<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Intelligence System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Title -->
                <div class="flex items-center">
                    <i class="fas fa-brain text-primary-500 text-2xl mr-3"></i>
                    <h1 class="text-xl font-semibold text-gray-900 dark:text-white">Email Intelligence</h1>
                    <a href="task_focused_interface.html" class="ml-4 px-3 py-1 bg-primary-500 text-white text-sm rounded-lg hover:bg-primary-600 transition-colors">
                        <i class="fas fa-tasks mr-1"></i>Task-Focused View
                    </a>
                </div>
                
                <!-- Navigation -->
                <nav class="hidden md:flex space-x-8">
                    <button class="nav-btn active" data-section="emails">
                        <i class="fas fa-inbox mr-2"></i>Emails
                    </button>
                    <button class="nav-btn" data-section="stats">
                        <i class="fas fa-chart-bar mr-2"></i>Analytics
                    </button>
                    <button class="nav-btn" data-section="tasks">
                        <i class="fas fa-tasks mr-2"></i>Tasks
                    </button>
                </nav>
                
                <!-- Controls -->
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button id="darkModeToggle" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline"></i>
                    </button>
                    <button id="mobileMenuBtn" class="md:hidden p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Navigation -->
        <div id="mobileMenu" class="md:hidden hidden bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
            <div class="px-4 py-2 space-y-1">
                <button class="mobile-nav-btn active" data-section="emails">
                    <i class="fas fa-inbox mr-2"></i>Emails
                </button>
                <button class="mobile-nav-btn" data-section="stats">
                    <i class="fas fa-chart-bar mr-2"></i>Analytics
                </button>
                <button class="mobile-nav-btn" data-section="tasks">
                    <i class="fas fa-tasks mr-2"></i>Tasks
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden">
        <!-- Email Section -->
        <section id="emailsSection" class="h-screen">
            <div class="flex h-full">
                <!-- Email List -->
                <div class="w-full lg:w-1/2 xl:w-2/5 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col">
                    <!-- Search and Filters -->
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                        <div class="relative mb-3">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="searchInput" placeholder="Search emails..." 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="urgent">Urgent</button>
                            <button class="filter-btn" data-filter="action_required">Action Required</button>
                            <button class="filter-btn" data-filter="informational">Informational</button>
                            <button class="filter-btn" data-filter="unread">Unread</button>
                        </div>
                    </div>
                    
                    <!-- Email List Container -->
                    <div class="flex-1 overflow-y-auto" id="emailList">
                        <div class="p-8 text-center text-gray-500 dark:text-gray-400">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading emails...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Email Detail View -->
                <div class="hidden lg:flex lg:flex-1 bg-white dark:bg-gray-800 flex-col" id="emailDetail">
                    <div class="p-8 text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-envelope-open text-4xl mb-4 opacity-50"></i>
                        <h3 class="text-lg font-medium mb-2">Select an email</h3>
                        <p>Choose an email from the list to view its contents</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section id="statsSection" class="hidden p-6 max-w-7xl mx-auto">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Email Analytics</h2>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="statsGrid">
                <div class="stats-card">
                    <div class="flex items-center">
                        <div class="p-3 rounded-lg bg-blue-100 dark:bg-blue-900/20">
                            <i class="fas fa-envelope text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Emails</p>
                            <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="totalEmails">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="flex items-center">
                        <div class="p-3 rounded-lg bg-red-100 dark:bg-red-900/20">
                            <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Urgent</p>
                            <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="urgentEmails">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="flex items-center">
                        <div class="p-3 rounded-lg bg-yellow-100 dark:bg-yellow-900/20">
                            <i class="fas fa-clipboard-check text-yellow-600 dark:text-yellow-400"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Action Required</p>
                            <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="actionRequiredEmails">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="stats-card">
                    <div class="flex items-center">
                        <div class="p-3 rounded-lg bg-green-100 dark:bg-green-900/20">
                            <i class="fas fa-check-circle text-green-600 dark:text-green-400"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Processed</p>
                            <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="processedEmails">-</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts Placeholder -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Classification Distribution</h3>
                    <div class="h-64 flex items-center justify-center text-gray-500 dark:text-gray-400">
                        <div class="text-center">
                            <i class="fas fa-chart-pie text-4xl mb-2 opacity-50"></i>
                            <p>Chart visualization would go here</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Email Volume Over Time</h3>
                    <div class="h-64 flex items-center justify-center text-gray-500 dark:text-gray-400">
                        <div class="text-center">
                            <i class="fas fa-chart-line text-4xl mb-2 opacity-50"></i>
                            <p>Chart visualization would go here</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section id="tasksSection" class="hidden p-6 max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Generated Tasks</h2>
                <button id="refreshTasks" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                <div class="p-6" id="tasksList">
                    <div class="text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading tasks...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Mobile Email Detail Modal -->
    <div id="mobileEmailModal" class="fixed inset-0 z-50 hidden lg:hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50" id="mobileModalOverlay"></div>
        <div class="fixed inset-0 bg-white dark:bg-gray-800 flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Email Details</h3>
                <button id="closeMobileModal" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4" id="mobileEmailContent">
                <!-- Email content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <style>
        .nav-btn {
            @apply px-4 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white border-b-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600 transition-colors duration-200;
        }
        
        .nav-btn.active {
            @apply text-primary-600 dark:text-primary-400 border-primary-600 dark:border-primary-400;
        }
        
        .mobile-nav-btn {
            @apply w-full text-left px-3 py-2 rounded-md text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700;
        }
        
        .mobile-nav-btn.active {
            @apply text-primary-600 dark:text-primary-400 bg-primary-50 dark:bg-primary-900/20;
        }
        
        .filter-btn {
            @apply px-3 py-1 text-sm rounded-full border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors;
        }
        
        .filter-btn.active {
            @apply bg-primary-500 text-white border-primary-500;
        }
        
        .stats-card {
            @apply bg-white dark:bg-gray-800 rounded-lg shadow p-6;
        }
        
        .email-item {
            @apply p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors;
        }
        
        .email-item.unread {
            @apply bg-blue-50 dark:bg-blue-900/10;
        }
        
        .email-item.selected {
            @apply bg-primary-50 dark:bg-primary-900/20 border-r-2 border-primary-500;
        }
        
        .classification-badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        
        .classification-urgent {
            @apply bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400;
        }
        
        .classification-action_required {
            @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400;
        }
        
        .classification-informational {
            @apply bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400;
        }
        
        .classification-spam {
            @apply bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300;
        }
        
        .task-item {
            @apply p-4 border-b border-gray-200 dark:border-gray-700 last:border-b-0;
        }
        
        .toast {
            @apply bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-4 max-w-sm transform transition-all duration-300;
        }
        
        .toast.success {
            @apply border-green-200 dark:border-green-700 bg-green-50 dark:bg-green-900/20;
        }
        
        .toast.error {
            @apply border-red-200 dark:border-red-700 bg-red-50 dark:bg-red-900/20;
        }
    </style>

    <script>
        // Application State
        let state = {
            emails: [],
            tasks: [],
            stats: {},
            selectedEmail: null,
            currentFilter: 'all',
            currentSection: 'emails',
            isDarkMode: localStorage.getItem('darkMode') === 'true'
        };

        // API Base URL
        const API_BASE = 'http://localhost:8000';

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            applyDarkMode();
            loadEmails();
            loadStats();
            loadTasks();
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchSection(e.target.dataset.section));
            });

            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('closeMobileModal').addEventListener('click', closeMobileModal);
            document.getElementById('mobileModalOverlay').addEventListener('click', closeMobileModal);

            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', refreshData);

            // Search
            document.getElementById('searchInput').addEventListener('input', handleSearch);

            // Filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => setFilter(e.target.dataset.filter));
            });

            // Tasks refresh
            document.getElementById('refreshTasks').addEventListener('click', loadTasks);
        }

        function switchSection(section) {
            state.currentSection = section;
            
            // Update navigation
            document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === section);
            });

            // Show/hide sections
            document.getElementById('emailsSection').classList.toggle('hidden', section !== 'emails');
            document.getElementById('statsSection').classList.toggle('hidden', section !== 'stats');
            document.getElementById('tasksSection').classList.toggle('hidden', section !== 'tasks');

            // Close mobile menu
            document.getElementById('mobileMenu').classList.add('hidden');
        }

        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('hidden');
        }

        function toggleDarkMode() {
            state.isDarkMode = !state.isDarkMode;
            localStorage.setItem('darkMode', state.isDarkMode);
            applyDarkMode();
        }

        function applyDarkMode() {
            document.documentElement.classList.toggle('dark', state.isDarkMode);
        }

        function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('animate-spin');
            
            Promise.all([loadEmails(), loadStats(), loadTasks()])
                .finally(() => {
                    btn.classList.remove('animate-spin');
                    showToast('Data refreshed', 'success');
                });
        }

        // API Functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API call failed for ${endpoint}:`, error);
                showToast(`Failed to load data: ${error.message}`, 'error');
                return null;
            }
        }

        async function loadEmails() {
            const data = await apiCall('/emails/');
            if (data) {
                state.emails = data;
                renderEmailList();
            }
        }

        async function loadStats() {
            const data = await apiCall('/stats/');
            if (data) {
                state.stats = data;
                renderStats();
            }
        }

        async function loadTasks() {
            const data = await apiCall('/tasks/');
            if (data) {
                state.tasks = data;
                renderTasks();
            }
        }

        async function markEmailAsRead(emailId) {
            const result = await apiCall(`/emails/${emailId}/mark-read`, { method: 'POST' });
            if (result) {
                const email = state.emails.find(e => e.id === emailId);
                if (email) {
                    email.read = true;
                    renderEmailList();
                }
            }
        }

        async function replyToEmail(emailId, replyText) {
            const result = await apiCall(`/emails/${emailId}/reply`, {
                method: 'POST',
                body: JSON.stringify({ reply: replyText })
            });
            
            if (result) {
                showToast('Reply sent successfully', 'success');
                return true;
            }
            return false;
        }

        // Render Functions
        function renderEmailList() {
            const container = document.getElementById('emailList');
            const filteredEmails = getFilteredEmails();

            if (filteredEmails.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-4 opacity-50"></i>
                        <h3 class="text-lg font-medium mb-2">No emails found</h3>
                        <p>Try adjusting your filters or search terms</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredEmails.map(email => `
                <div class="email-item ${email.read ? '' : 'unread'} ${state.selectedEmail?.id === email.id ? 'selected' : ''}" 
                     onclick="selectEmail(${email.id})">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-medium text-gray-900 dark:text-white truncate flex-1 mr-2">
                            ${email.sender || 'Unknown Sender'}
                        </h3>
                        <span class="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">
                            ${formatDate(email.date)}
                        </span>
                    </div>
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 truncate">
                        ${email.subject || 'No Subject'}
                    </h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 line-clamp-2">
                        ${email.preview || email.body?.substring(0, 100) || 'No preview available'}
                    </p>
                    <div class="flex justify-between items-center">
                        <span class="classification-badge classification-${email.classification || 'informational'}">
                            ${formatClassification(email.classification)}
                        </span>
                        <div class="flex items-center space-x-2 text-gray-400">
                            ${!email.read ? '<i class="fas fa-circle text-blue-500 text-xs"></i>' : ''}
                            ${email.has_attachments ? '<i class="fas fa-paperclip text-xs"></i>' : ''}
                            ${email.priority === 'high' ? '<i class="fas fa-exclamation text-red-500 text-xs"></i>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderEmailDetail(email) {
            const container = document.getElementById('emailDetail');
            const mobileContainer = document.getElementById('mobileEmailContent');
            
            const content = `
                <div class="border-b border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                                ${email.subject || 'No Subject'}
                            </h2>
                            <div class="flex items-center space-x-4 text-sm text-gray-600 dark:text-gray-400">
                                <span><strong>From:</strong> ${email.sender || 'Unknown'}</span>
                                <span><strong>Date:</strong> ${formatDate(email.date)}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="classification-badge classification-${email.classification || 'informational'}">
                                ${formatClassification(email.classification)}
                            </span>
                            ${!email.read ? 
                                `<button onclick="markEmailAsRead(${email.id})" class="p-2 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded">
                                    <i class="fas fa-eye"></i>
                                </button>` : ''
                            }
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 p-6 overflow-y-auto">
                    <div class="prose dark:prose-invert max-w-none">
                        ${email.body ? email.body.replace(/\n/g, '<br>') : 'No content available'}
                    </div>
                    
                    ${email.ai_summary ? `
                        <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <h3 class="font-medium text-blue-900 dark:text-blue-200 mb-2">
                                <i class="fas fa-robot mr-2"></i>AI Summary
                            </h3>
                            <p class="text-blue-800 dark:text-blue-300">${email.ai_summary}</p>
                        </div>
                    ` : ''}
                    
                    ${email.suggested_actions?.length ? `
                        <div class="mt-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                            <h3 class="font-medium text-yellow-900 dark:text-yellow-200 mb-2">
                                <i class="fas fa-lightbulb mr-2"></i>Suggested Actions
                            </h3>
                            <ul class="list-disc list-inside text-yellow-800 dark:text-yellow-300">
                                ${email.suggested_actions.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 p-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="showReplyDialog(${email.id})" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
                            <i class="fas fa-reply mr-2"></i>Reply
                        </button>
                        <button onclick="forwardEmail(${email.id})" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            <i class="fas fa-share mr-2"></i>Forward
                        </button>
                        ${!email.read ? 
                            `<button onclick="markEmailAsRead(${email.id})" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-eye mr-2"></i>Mark as Read
                            </button>` : ''
                        }
                    </div>
                </div>
            `;
            
            container.innerHTML = content;
            container.classList.remove('hidden');
            
            if (mobileContainer) {
                mobileContainer.innerHTML = content;
            }
        }

        function renderStats() {
            if (!state.stats) return;
            
            document.getElementById('totalEmails').textContent = state.stats.total_emails || 0;
            document.getElementById('urgentEmails').textContent = state.stats.urgent_emails || 0;
            document.getElementById('actionRequiredEmails').textContent = state.stats.action_required_emails || 0;
            document.getElementById('processedEmails').textContent = state.stats.processed_emails || 0;
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            
            if (!state.tasks || state.tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <i class="fas fa-tasks text-4xl mb-4 opacity-50"></i>
                        <h3 class="text-lg font-medium mb-2">No tasks available</h3>
                        <p>Tasks will appear here when emails are processed</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.tasks.map(task => `
                <div class="task-item">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900 dark:text-white mb-2">
                                ${task.title || 'Untitled Task'}
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                ${task.description || 'No description available'}
                            </p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-400">
                                <span><i class="fas fa-calendar mr-1"></i>${formatDate(task.created_at)}</span>
                                <span><i class="fas fa-envelope mr-1"></i>Email #${task.email_id}</span>
                                ${task.due_date ? `<span><i class="fas fa-clock mr-1"></i>Due: ${formatDate(task.due_date)}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                ${task.priority === 'high' ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400' : 
                                  task.priority === 'medium' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400' : 
                                  'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400'}">
                                ${task.priority || 'normal'}
                            </span>
                            <button onclick="markTaskComplete(${task.id})" class="p-1 text-gray-400 hover:text-green-600 dark:hover:text-green-400">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Event Handlers
        function selectEmail(emailId) {
            const email = state.emails.find(e => e.id === emailId);
            if (email) {
                state.selectedEmail = email;
                renderEmailDetail(email);
                renderEmailList(); // Refresh to show selection
                
                // Mark as read if unread
                if (!email.read) {
                    markEmailAsRead(emailId);
                }
                
                // Show mobile modal on small screens
                if (window.innerWidth < 1024) {
                    document.getElementById('mobileEmailModal').classList.remove('hidden');
                }
            }
        }

        function closeMobileModal() {
            document.getElementById('mobileEmailModal').classList.add('hidden');
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            // Search is handled in getFilteredEmails()
            renderEmailList();
        }

        function setFilter(filter) {
            state.currentFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            renderEmailList();
        }

        function getFilteredEmails() {
            let filtered = [...state.emails];
            
            // Apply search
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            if (searchQuery) {
                filtered = filtered.filter(email => 
                    (email.subject?.toLowerCase().includes(searchQuery)) ||
                    (email.sender?.toLowerCase().includes(searchQuery)) ||
                    (email.body?.toLowerCase().includes(searchQuery))
                );
            }
            
            // Apply filter
            if (state.currentFilter !== 'all') {
                if (state.currentFilter === 'unread') {
                    filtered = filtered.filter(email => !email.read);
                } else {
                    filtered = filtered.filter(email => email.classification === state.currentFilter);
                }
            }
            
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Dialog Functions
        function showReplyDialog(emailId) {
            const reply = prompt('Enter your reply:');
            if (reply) {
                replyToEmail(emailId, reply);
            }
        }

        function forwardEmail(emailId) {
            const email = state.emails.find(e => e.id === emailId);
            if (email) {
                showToast('Forward functionality would be implemented here', 'info');
            }
        }

        function markTaskComplete(taskId) {
            // This would make an API call to mark the task as complete
            showToast('Task marked as complete', 'success');
            state.tasks = state.tasks.filter(t => t.id !== taskId);
            renderTasks();
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) {
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            } else if (days === 1) {
                return 'Yesterday';
            } else if (days < 7) {
                return `${days} days ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        function formatClassification(classification) {
            if (!classification) return 'Informational';
            return classification.replace('_', ' ').split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? 'check-circle' : 
                        type === 'error' ? 'exclamation-triangle' : 
                        'info-circle';
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${icon} mr-3 ${
                        type === 'success' ? 'text-green-600 dark:text-green-400' :
                        type === 'error' ? 'text-red-600 dark:text-red-400' :
                        'text-blue-600 dark:text-blue-400'
                    }"></i>
                    <span class="text-gray-900 dark:text-white">${message}</span>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        // Handle responsive behavior
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 1024) {
                closeMobileModal();
            }
        });
    </script>
</body>
</html>